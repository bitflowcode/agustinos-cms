import React, { useState, useEffect, useCallback } from 'react';
import {
  Card,
  Form,
  Input,
  Select,
  Button,
  Space,
  Row,
  Col,
  Typography,
  message,
  Layout,
  Spin,
  Upload,
  DatePicker
} from 'antd';
import {
  SaveOutlined,
  ArrowLeftOutlined,
  PlusOutlined,
  UploadOutlined
} from '@ant-design/icons';
import { useNavigate, useParams } from 'react-router-dom';
import ReactQuill from 'react-quill';
import 'react-quill/dist/quill.snow.css';
import { articlesAPI } from '../utils/api';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { Option } = Select;
const { Content } = Layout;

const ArticleEditor = () => {
  const navigate = useNavigate();
  const { id } = useParams();
  const isEditing = Boolean(id);
  const [form] = Form.useForm();

  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [sections, setSections] = useState([]);
  const [content, setContent] = useState('');
  const [currentArticle, setCurrentArticle] = useState(null);
  const [imageUrl, setImageUrl] = useState('');
  const [audioUrl, setAudioUrl] = useState('');
  const [uploadingImage, setUploadingImage] = useState(false);
  const [uploadingAudio, setUploadingAudio] = useState(false);
  const [articleDate, setArticleDate] = useState(null);

  // Configuración básica del editor Quill
  const quillModules = {
    toolbar: [
      [{ 'header': [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }],
      ['link', 'blockquote'],
      ['clean']
    ],
  };

  const quillFormats = [
    'header', 'bold', 'italic', 'underline', 'strike',
    'list', 'bullet', 'link', 'blockquote'
  ];

  // Cargar artículo existente si está editando
  const loadArticle = useCallback(async (articleId) => {
    setLoading(true);
    try {
      const response = await articlesAPI.getArticleById(articleId);
      
      if (response.success) {
        const article = response.data;
        setCurrentArticle(article);
        
        // Llenar el formulario con los datos existentes
        form.setFieldsValue({
          title: article.title,
          section: article.section,
          subtitle: article.subtitle,
          description: article.description,
          date: article.date ? dayjs(article.date) : null
        });
        
        // Establecer el contenido en el editor
        setContent(article.content || '');
        
        // Establecer imagen y audio si existen
        setImageUrl(article.imageUrl || '');
        setAudioUrl(article.audioUrl || '');
        
        message.success('Artículo cargado para edición');
      } else {
        message.error('No se pudo cargar el artículo');
        navigate('/articles');
      }
    } catch (error) {
      console.error('Error loading article:', error);
      message.error('Error al cargar el artículo');
      navigate('/articles');
    } finally {
      setLoading(false);
    }
  }, [navigate, form]);

  // Cargar secciones
  const loadSections = async () => {
    try {
      const response = await articlesAPI.getSections();
      
      if (response.success) {
        // Los datos vienen como: { "Buenos días": [...], "Evangelio": [...], etc }
        const sectionsData = response.data;
        
        // Convertir las claves del objeto en un array de secciones
        const sectionNames = Object.keys(sectionsData).map(sectionName => ({
          section_name: sectionName,
          article_count: sectionsData[sectionName].length
        }));
        
        setSections(sectionNames);
      }
    } catch (error) {
      console.error('Error loading sections:', error);
    }
  };

  // Función para subir imagen a Bunny CDN
  const handleImageUpload = async (file) => {
    const isJpgOrPng = file.type === 'image/jpeg' || file.type === 'image/png' || file.type === 'image/webp';
    if (!isJpgOrPng) {
      message.error('Solo puedes subir archivos JPG, PNG o WebP');
      return false;
    }

    const isLt5M = file.size / 1024 / 1024 < 5;
    if (!isLt5M) {
      message.error('La imagen debe ser menor a 5MB');
      return false;
    }

    setUploadingImage(true);

    try {
      const formData = new FormData();
      formData.append('file', file);
    
      // Obtener token de autenticación
      const token = localStorage.getItem('cms_token');
      
      // Upload real a Bunny CDN
      const response = await fetch('https://agustinos-cms.vercel.app/api/upload-image', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
    
      const result = await response.json();
      
      if (result.success) {
        setImageUrl(result.data.imageUrl);
        message.success('Imagen subida exitosamente');
      } else {
        message.error(result.error || 'Error al subir imagen');
      }

    } catch (error) {
      message.error('Error al subir la imagen');
    } finally {
      setUploadingImage(false);
    }

    return false; // Prevenir upload automático de Ant Design
  };

  // Función para subir audio a Bunny CDN
  const handleAudioUpload = async (file) => {
    const isAudio = file.type.startsWith('audio/');
    if (!isAudio) {
      message.error('Solo puedes subir archivos de audio');
      return false;
    }

    const isLt10M = file.size / 1024 / 1024 < 10;
    if (!isLt10M) {
      message.error('El audio debe ser menor a 10MB');
      return false;
    }

    setUploadingAudio(true);

    try {
      const formData = new FormData();
      formData.append('file', file);
    
      // Obtener token de autenticación
      const token = localStorage.getItem('cms_token');
      
      // Upload real a Bunny CDN
      const response = await fetch('https://agustinos-cms.vercel.app/api/upload-audio', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
    
      const result = await response.json();
      
      if (result.success) {
        setAudioUrl(result.data.audioUrl);
        message.success('Audio subido exitosamente');
      } else {
        message.error(result.error || 'Error al subir audio');
      }

    } catch (error) {
      message.error('Error al subir el audio');
    } finally {
      setUploadingAudio(false);
    }

    return false; // Prevenir upload automático de Ant Design
  };

  // Guardar artículo (crear o actualizar)
  const handleSave = async () => {
    try {
      const values = await form.validateFields();
      
      if (!content.trim()) {
        message.error('El contenido es obligatorio');
        return;
      }

      setSaving(true);

      const articleData = {
        title: values.title,
        subtitle: values.subtitle || null,
        description: values.description || null,
        content: content,
        section: values.section || 'General',
        imageUrl: imageUrl || null,
        hasAudio: Boolean(audioUrl),
        audioUrl: audioUrl || null,
        date: values.date ? values.date.toISOString() : null
      };

      let response;
      
      if (isEditing) {
        // Actualizar artículo existente
        response = await articlesAPI.updateArticle(id, articleData);
        message.success('Artículo actualizado exitosamente');
      } else {
        // Crear nuevo artículo
        response = await articlesAPI.createArticle(articleData);
        message.success('Artículo creado exitosamente');
      }

      if (response.success) {
        navigate('/articles');
      }
    } catch (error) {
      if (error.errorFields) {
        message.error('Por favor completa todos los campos requeridos');
      } else {
        message.error(`Error al ${isEditing ? 'actualizar' : 'crear'} el artículo`);
        console.error('Error saving article:', error);
      }
    } finally {
      setSaving(false);
    }
  };

  useEffect(() => {
    loadSections();
    
    // Si está editando, cargar el artículo
    if (isEditing && id) {
      loadArticle(id);
    }
  }, [isEditing, id, loadArticle]);

  if (loading) {
    return (
      <Layout style={{ minHeight: '100vh', background: '#f0f2f5' }}>
        <Content style={{ padding: '50px', textAlign: 'center' }}>
          <Spin size="large" />
          <div style={{ marginTop: 16 }}>Cargando artículo...</div>
        </Content>
      </Layout>
    );
  }

  return (
    <Layout style={{ minHeight: '100vh', background: '#f0f2f5' }}>
      <Content style={{ padding: '24px' }}>
        {/* Header */}
        <Row justify="space-between" align="middle" style={{ marginBottom: 24 }}>
          <Col>
            <Space>
              <Button 
                icon={<ArrowLeftOutlined />} 
                onClick={() => navigate('/articles')}
              >
                Volver a Artículos
              </Button>
              <Title level={2} style={{ margin: 0 }}>
                {isEditing ? `Editar: ${currentArticle?.title || 'Artículo'}` : 'Nuevo Artículo'}
              </Title>
            </Space>
          </Col>
          <Col>
            <Space>
              <Button
                type="primary"
                icon={<SaveOutlined />}
                loading={saving}
                onClick={handleSave}
                size="large"
              >
                {isEditing ? 'Actualizar Artículo' : 'Publicar Artículo'}
              </Button>
            </Space>
          </Col>
        </Row>

        <Row gutter={24}>
          {/* Editor Principal */}
          <Col xs={24} lg={18}>
            <Card>
            <Form
              form={form}
              layout="vertical"
              size="large"
            >
              {/* Título */}
              <Form.Item
                name="title"
                label="Título del artículo"
                rules={[
                  { required: true, message: 'El título es obligatorio' },
                  { min: 5, message: 'El título debe tener al menos 5 caracteres' }
                ]}
              >
                <Input 
                  placeholder="Escribe un título atractivo..."
                  style={{ fontSize: '18px', fontWeight: 'bold' }}
                />
              </Form.Item>

              {/* Subtítulo (opcional) */}
              <Form.Item
                name="subtitle"
                label="Subtítulo (opcional)"
              >
                <Input 
                  placeholder="Subtítulo del artículo..."
                />
              </Form.Item>

              {/* Descripción (opcional) */}
              <Form.Item
                name="description"
                label="Descripción (opcional)"
              >
                <Input.TextArea 
                  rows={2}
                  placeholder="Breve descripción del artículo..."
                />
              </Form.Item>

              {/* Campo de fecha de publicación */}
              <Form.Item
                name="date"
                label="Fecha de publicación"
                tooltip="Selecciona cuándo se publicará este artículo. Déjalo vacío para usar la fecha actual."
              >
                <DatePicker
                  showTime
                  format="DD/MM/YYYY HH:mm"
                  placeholder="Seleccionar fecha y hora"
                  style={{ width: '100%' }}
                  onChange={(value) => setArticleDate(value)}
                />
              </Form.Item>

              {/* Campo de imagen */}
              <Form.Item
                label="Imagen del artículo (opcional)"
              >
                <Space direction="vertical" style={{ width: '100%' }}>
                  <Upload
                    name="image"
                    listType="picture-card"
                    className="image-uploader"
                    showUploadList={false}
                    beforeUpload={handleImageUpload}
                    accept="image/*"
                  >
                    {imageUrl ? (
                      <img 
                        src={imageUrl} 
                        alt="article" 
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }} 
                      />
                    ) : (
                      <div>
                        <PlusOutlined />
                        <div style={{ marginTop: 8 }}>Subir imagen</div>
                      </div>
                    )}
                  </Upload>
                  {imageUrl && (
                    <Button 
                      danger 
                      size="small" 
                      onClick={() => setImageUrl('')}
                    >
                      Eliminar imagen
                    </Button>
                  )}
                </Space>
              </Form.Item>

              {/* Campo de audio */}
              <Form.Item
                label="Audio del artículo (opcional)"
              >
                <Space direction="vertical" style={{ width: '100%' }}>
                  <Upload
                    name="audio"
                    showUploadList={false}
                    beforeUpload={handleAudioUpload}
                    accept="audio/*"
                  >
                    <Button icon={<UploadOutlined />}>
                      {audioUrl ? 'Cambiar audio' : 'Subir audio'}
                    </Button>
                  </Upload>
                  {audioUrl && (
                    <Space direction="vertical" style={{ width: '100%' }}>
                      <audio controls style={{ width: '100%' }}>
                        <source src={audioUrl} type="audio/mpeg" />
                        Tu navegador no soporta el elemento audio.
                      </audio>
                      <Button 
                        danger 
                        size="small" 
                        onClick={() => setAudioUrl('')}
                      >
                        Eliminar audio
                      </Button>
                    </Space>
                  )}
                </Space>
              </Form.Item>

              {/* Sección */}
              <Form.Item
                name="section"
                label="Sección"
              >
                <Select
                  placeholder="Selecciona una sección"
                  showSearch
                  allowClear
                  optionFilterProp="children"
                >
                  {sections.map(section => (
                    <Option key={section.section_name} value={section.section_name}>
                      {section.section_name} ({section.article_count} artículos)
                    </Option>
                  ))}
                </Select>
              </Form.Item>

              {/* Editor de contenido */}
              <Form.Item
                label="Contenido del artículo"
                required
              >
                <div style={{ border: '1px solid #d9d9d9', borderRadius: 6 }}>
                  <ReactQuill
                    theme="snow"
                    value={content}
                    onChange={setContent}
                    modules={quillModules}
                    formats={quillFormats}
                    style={{ minHeight: 300 }}
                    placeholder="Escribe el contenido de tu artículo aquí..."
                  />
                </div>
                {!content.trim() && (
                  <div style={{ color: '#ff4d4f', fontSize: '12px', marginTop: 4 }}>
                    El contenido es obligatorio
                  </div>
                )}
              </Form.Item>
            </Form>
            </Card>
          </Col>

          {/* Panel lateral */}
          <Col xs={24} lg={6}>
            <Card title="Información" size="small">
              <Space direction="vertical" style={{ width: '100%' }}>
                <div>
                  <Text type="secondary">Estado: </Text>
                  <Text strong>{isEditing ? 'Editando' : 'Nuevo artículo'}</Text>
                </div>
                {isEditing && currentArticle && (
                  <>
                    <div>
                      <Text type="secondary">ID: </Text>
                      <Text strong>{currentArticle.id}</Text>
                    </div>
                    <div>
                      <Text type="secondary">Creado: </Text>
                      <Text strong>
                        {new Date(currentArticle.created_at).toLocaleDateString('es-ES')}
                      </Text>
                    </div>
                    <div>
                      <Text type="secondary">Actualizado: </Text>
                      <Text strong>
                        {new Date(currentArticle.updated_at).toLocaleDateString('es-ES')}
                      </Text>
                    </div>
                  </>
                )}
                <div>
                  <Text type="secondary">Autor: </Text>
                  <Text strong>{currentArticle?.author || 'Agustinos'}</Text>
                </div>
                <div>
                  <Text type="secondary">Publicación: </Text>
                  <Text strong>
                    {form.getFieldValue('date') 
                      ? `Programada: ${dayjs(form.getFieldValue('date')).format('DD/MM/YYYY HH:mm')}` 
                      : 'Inmediata'
                    }
                  </Text>
                </div>
              </Space>
            </Card>

            <Card title="Estadísticas" size="small" style={{ marginTop: 16 }}>
              <Space direction="vertical" style={{ width: '100%' }}>
                <div>
                  <Text type="secondary">Caracteres: </Text>
                  <Text strong>{content.replace(/<[^>]*>/g, '').length}</Text>
                </div>
                <div>
                  <Text type="secondary">Palabras: </Text>
                  <Text strong>
                    {content.replace(/<[^>]*>/g, '').split(/\s+/).filter(w => w.length > 0).length}
                  </Text>
                </div>
                <div>
                  <Text type="secondary">Tiempo de lectura: </Text>
                  <Text strong>
                    {Math.max(1, Math.ceil(content.replace(/<[^>]*>/g, '').split(/\s+/).length / 200))} min
                  </Text>
                </div>
              </Space>
            </Card>
          </Col>
        </Row>
      </Content>
    </Layout>
  );
};

export default ArticleEditor;